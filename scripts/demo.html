<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voting DApp Demo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    .header h1 {
      font-size: 3rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .status-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .connection-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff4757;
    }

    .status-dot.connected {
      background: #2ed573;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .contract-form {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .contract-form input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 16px;
      min-width: 300px;
    }

    .candidates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .candidate-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .candidate-card:hover {
      transform: translateY(-5px);
    }

    .candidate-name {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    .vote-count {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 15px;
    }

    .vote-btn {
      width: 100%;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    }

    .vote-btn:hover {
      background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      color: #666;
      margin-top: 5px;
    }

    .winner-card {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #333;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .winner-card h2 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .owner-box {
      margin: 20px auto;
      padding: 20px;
      max-width: 400px;
      border: 2px solid #4caf50;
      border-radius: 12px;
      background: #f9fff9;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .owner-box h2 {
      color: #2e7d32;
      font-size: 20px;
      margin-bottom: 15px;
    }

    .owner-box label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .owner-box input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .owner-box button {
      background: #4caf50;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .owner-box button:hover {
      background: #388e3c;
    }


    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error {
      background: #ff4757;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .success {
      background: #2ed573;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }

      .contract-form {
        flex-direction: column;
      }

      .contract-form input {
        min-width: auto;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1>üó≥Ô∏è Voting DApp</h1>
      <p>Decentralized Voting System Demo</p>
    </header>

    <div class="status-card">
      <div class="connection-status">
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Not Connected</span>
        </div>
        <button class="btn" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
        <button class="btn" id="disconnectBtn" style="display:none;" onclick="disconnectWallet()">Disconnect</button>
      </div>

      <div id="accountInfo" style="display: none;">
        <p><strong>Account:</strong> <span id="userAccount"></span></p>
        <p><strong>Network:</strong> <span id="networkInfo"></span></p>
      </div>
    </div>

    <div class="status-card" id="ownerActions" style="display:none; margin-top:20px;">

      <h2>üëë Owner Actions</h2>

      <button class="btn" onclick="startVoting()">Start Voting</button>
      <button class="btn" onclick="stopVoting()">Stop Voting</button>

      <div class="contract-form">
        <input type="text" class="contract-form" id="newCandidate" placeholder="Candidate Name" />
      </div>
      <button class="btn" onclick="addCandidate()">Add Candidate</button>

    </div>

    <div id="contractData" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalVotes">0</div>
          <div class="stat-label">Total Votes</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="candidateCount">0</div>
          <div class="stat-label">Candidates</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="votingStatus">‚ùå</div>
          <div class="stat-label">Voting Active</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="hasVoted">‚ùå</div>
          <div class="stat-label">You Voted</div>
        </div>
      </div>

      <div id="winnerCard" class="winner-card" style="display: none;">
        <h2>üèÜ Current Winner</h2>
        <p id="winnerInfo"></p>
      </div>

      <div class="candidates-grid" id="candidatesGrid">
        <!-- Candidates will be loaded here -->
      </div>

    </div>

    <div id="messages"></div>
  </div>

  <script>
    const CONTRACT_ADDRESS = "0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9";
    let provider, signer, contract;
    let userAccount = '';

    const VOTING_ABI = [
      "function vote(uint256 candidateIndex) external",
      "function getCandidates() external view returns (tuple(string name, uint256 voteCount)[])",
      "function getCandidate(uint256 index) external view returns (string name, uint256 voteCount)",
      "function getCandidateCount() external view returns (uint256)",
      "function getWinner() external view returns (string name, uint256 voteCount, uint256 index)",
      "function hasAddressVoted(address voter) external view returns (bool)",
      "function getVotingStats() external view returns (uint256 totalVotesCount, uint256 candidateCount, bool isActive)",
      "function owner() external view returns (address)",
      "function votingActive() external view returns (bool)",

      "function setVotingStatus(bool active) external",
      "function addCandidate(string memory candidateName) external",

      "event Voted(address indexed voter, uint256 candidateIndex, string candidateName)"
    ];

    async function connectWallet() {
      try {
        if (typeof window.ethereum !== 'undefined') {
          provider = new ethers.BrowserProvider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = await provider.getSigner();
          userAccount = await signer.getAddress();

          updateConnectionStatus(true);
          showMessage('Wallet connected successfully!', 'success');

          // Get network info
          const network = await provider.getNetwork();
          document.getElementById('networkInfo').textContent = `${network.name} (${network.chainId})`;
          document.getElementById('userAccount').textContent = `${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
          document.getElementById('accountInfo').style.display = 'block';
          document.getElementById("connectBtn").style.display = "none";
          document.getElementById("disconnectBtn").style.display = "inline-block";

          await loadContract();
        } else {
          showMessage('Please install MetaMask!', 'error');
        }
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
      }
    }

    function disconnectWallet() {
      provider = null;
      signer = null;
      votingContract = null;

      updateConnectionStatus(false);
      showMessage('Wallet disconnected.', 'success');

      document.getElementById('accountInfo').style.display = 'none';;
      document.getElementById("connectBtn").style.display = "inline-block";
      document.getElementById("disconnectBtn").style.display = "none";
      document.getElementById("owner-settings").style.display = "none";
    }

    function updateConnectionStatus(connected) {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const connectBtn = document.getElementById('connectBtn');

      if (connected) {
        statusDot.classList.add('connected');
        statusText.textContent = 'Connected';
        connectBtn.textContent = 'Connected';
        connectBtn.disabled = true;
      } else {
        statusDot.classList.remove('connected');
        statusText.textContent = 'Not Connected';
        connectBtn.textContent = 'Connect Wallet';
        connectBtn.disabled = false;
      }
    }

    async function loadContract() {
      try {
        if (!provider) {
          showMessage('Please connect wallet first!', 'error');
          return;
        }

        if (!ethers.isAddress(CONTRACT_ADDRESS)) {
          showMessage('Invalid contract address!', 'error');
          return;
        }

        contract = new ethers.Contract(CONTRACT_ADDRESS, VOTING_ABI, signer);
        await checkIsOwner(CONTRACT_ADDRESS).then(isOwner => {
          if (isOwner) {
            console.log("User is the contract owner.");
            document.getElementById("ownerActions").style.display = "block";
          }
        });
        await contract.getCandidateCount();

        // Test contract connection
        await contract.getCandidateCount();

        showMessage('Contract loaded successfully!', 'success');
        document.getElementById('contractData').style.display = 'block';

        await loadContractData();

        // Setup event listeners
        contract.on("Voted", (voter, candidateIndex, candidateName) => {
          showMessage(`Vote cast for ${candidateName}!`, 'success');
          loadContractData();
        });


      } catch (error) {
        showMessage(`Error loading contract: ${error.message}`, 'error');
      }
    }

    async function loadContractData() {
      try {
        // Get voting stats
        const [totalVotes, candidateCount, isActive] = await contract.getVotingStats();
        document.getElementById('totalVotes').textContent = totalVotes.toString();
        document.getElementById('candidateCount').textContent = candidateCount.toString();
        document.getElementById('votingStatus').textContent = isActive ? '‚úÖ' : '‚ùå';

        // Check if user has voted
        const hasVoted = await contract.hasAddressVoted(userAccount);
        document.getElementById('hasVoted').textContent = hasVoted ? '‚úÖ' : '‚ùå';

        // Load candidates
        const candidates = await contract.getCandidates();
        displayCandidates(candidates, isActive && !hasVoted);

        // Show winner if there are votes
        if (totalVotes > 0) {
          const [winnerName, winnerVotes, winnerIndex] = await contract.getWinner();
          document.getElementById('winnerInfo').textContent = `${winnerName} with ${winnerVotes} votes`;
          document.getElementById('winnerCard').style.display = 'block';
        } else {
          document.getElementById('winnerCard').style.display = 'none';
        }

      } catch (error) {
        showMessage(`Error loading data: ${error.message}`, 'error');
      }
    }

    function displayCandidates(candidates, canVote) {
      const grid = document.getElementById('candidatesGrid');
      grid.innerHTML = '';

      candidates.forEach((candidate, index) => {
        const card = document.createElement('div');
        card.className = 'candidate-card';
        card.innerHTML = `
                    <div class="candidate-name">${candidate.name}</div>
                    <div class="vote-count">${candidate.voteCount.toString()}</div>
                    <button 
                        class="btn vote-btn" 
                        onclick="vote(${index})"
                        ${canVote ? '' : 'disabled'}
                        id="voteBtn${index}"
                    >
                        ${canVote ? 'Vote' : 'Voting Disabled'}
                    </button>
                `;
        grid.appendChild(card);
      });
    }

    async function vote(candidateIndex) {
      try {
        const btn = document.getElementById(`voteBtn${candidateIndex}`);
        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="loading"></div> Voting...';
        btn.disabled = true;

        const tx = await contract.vote(candidateIndex);
        showMessage('Transaction sent! Waiting for confirmation...', 'success');

        const receipt = await tx.wait();
        showMessage(`Vote confirmed! Block: ${receipt.blockNumber}`, 'success');

        await loadContractData();

      } catch (error) {
        showMessage(`Voting failed: ${error.message}`, 'error');
        document.getElementById(`voteBtn${candidateIndex}`).innerHTML = 'Vote';
        document.getElementById(`voteBtn${candidateIndex}`).disabled = false;
      }
    }

    function showMessage(message, type) {
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = type;
      messageDiv.textContent = message;
      messagesDiv.appendChild(messageDiv);

      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // Auto-connect if previously connected
    window.addEventListener('load', async () => {
      if (typeof window.ethereum !== 'undefined' && window.ethereum.selectedAddress) {
        await connectWallet();
      }
    });

    // Handle account changes
    if (typeof window.ethereum !== 'undefined') {
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
          updateConnectionStatus(false);
          document.getElementById('contractData').style.display = 'none';
          document.getElementById('accountInfo').style.display = 'none';
        } else {
          connectWallet();
        }
      });

      window.ethereum.on('chainChanged', () => {
        window.location.reload();
      });
    }

    document.getElementById("setTitleBtn").addEventListener("click", async () => {
      const title = document.getElementById("votingTitle").value;
      try {
        const tx = await votingContract.setVotingTitle(title);
        await tx.wait();
        alert("Voting title updated!");
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    async function checkIsOwner(contractAddress) {
      const userAddress = await signer.getAddress();
      const contractTemp = new ethers.Contract(contractAddress, VOTING_ABI, signer);
      const owner = await contractTemp.owner();
      return userAddress.toLowerCase() === owner.toLowerCase();
    }

    async function setVotingTitle() {
      try {
        const title = document.getElementById("titleInput").value;
        if (!title) {
          showMessage("Please enter a title!", "error");
          return;
        }

        const tx = await contract.setVotingTitle(title);
        showMessage("Transaction sent! Waiting for confirmation...", "success");
        await tx.wait();
        showMessage("Voting title updated!", "success");
      } catch (error) {
        showMessage(`Error: ${error.message}`, "error");
      }
    }

    async function startVoting() {
      try {
        const tx = await contract.setVotingStatus(true);
        showMessage("Starting voting...", "success");
        await tx.wait();
        showMessage("Voting started ‚úÖ", "success");
        await loadContractData();
      } catch (error) {
        showMessage(`Error: ${error.message}`, "error");
      }
    }

    async function stopVoting() {
      try {
        const tx = await contract.setVotingStatus(false);
        showMessage("Stopping voting...", "success");
        await tx.wait();
        showMessage("Voting stopped ‚ùå", "success");
        await loadContractData();
      } catch (error) {
        showMessage(`Error: ${error.message}`, "error");
      }
    }

    async function addCandidate() {
      try {
        const name = document.getElementById("newCandidate").value;
        if (!name) {
          showMessage("Please enter candidate name!", "error");
          return;
        }
        const tx = await contract.addCandidate(name);
        showMessage("Adding candidate...", "success");
        await tx.wait();
        showMessage(`Candidate "${name}" added ‚úÖ`, "success");
        await loadContractData();
      } catch (error) {
        showMessage(`Error: ${error.message}`, "error");
      }
    }

    window.addEventListener("load", connectWallet);
  </script>
</body>

</html>